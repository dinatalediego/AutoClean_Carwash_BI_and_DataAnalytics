name: CarWash Reports + Email

on:
  schedule:
    - cron: "*/5 * * * *"        # cada 5 minutos (para pruebas)
  push:
    paths:
      - "data/**/*.csv"          # ajusta al path donde subas tus csv
      - "output/**/*.csv"

jobs:
  build-and-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pipeline + reports
        run: |
          python generate_reports.py

      - name: Build email body from kpi_pack
        id: email_body
        run: |
          echo "body<<EOF" >> $GITHUB_OUTPUT
          python build_email_summary.py >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send email with reports
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "CarWash – Reportes automáticos (run ${{ github.run_number }})"
          to: "ddinatale.r@gmail.com"
          from: "CarWash Bot <${{ secrets.GMAIL_USER }}>"
          body: ${{ steps.email_body.outputs.body }}
          attachments: |
            output/Reporte_Inteligencia_Comercial_CarWash.pptx
            output/Informe_Ejecutivo_CarWash.pdf
            output/Script_Verbal_CarWash.txt
            output/Correo_Propuesta_CarWash.txt
